# Installation Guide

## Prerequisites

- **PHP** 8.2 or higher
- **Composer** 2.x
- **MySQL** 8.0 or higher
- **Node.js** (optional, for frontend assets)

### Required PHP Extensions

- BCMath, Ctype, cURL, DOM, Fileinfo, JSON, Mbstring, OpenSSL, PDO, PDO_MySQL, Tokenizer, XML

## Installation Steps

### 1. Clone the Repository

```bash
git clone <repository-url>
cd daftara_task
```

### 2. Install PHP Dependencies

```bash
composer install
```

### 3. Run the Install Command

```bash
php artisan daftara:install --seed
```

This single command handles everything:
- Creates `.env` from `.env.example` (if `.env` doesn't exist)
- Generates the application encryption key
- Runs all database migrations
- Seeds roles and permissions (superadmin, manager, staff)
- Seeds notification channels (email)
- Seeds demo users (3 users)
- With `--seed` flag: seeds sample warehouses, inventory items, stock levels, and notification subscriptions
- Clears config, cache, and route caches

### 4. Configure Your Environment

Edit the `.env` file to match your environment:

```ini
# Application
APP_NAME=Daftara
APP_URL=http://localhost:8000

# Database
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=daftara
DB_USERNAME=root
DB_PASSWORD=

# Mail (for low-stock email notifications)
MAIL_MAILER=smtp
MAIL_HOST=your-smtp-host
MAIL_PORT=465
MAIL_USERNAME=your-email@example.com
MAIL_PASSWORD=your-password
MAIL_ENCRYPTION=ssl
MAIL_FROM_ADDRESS="no-reply@example.com"
MAIL_FROM_NAME="${APP_NAME}"
```

> **Note:** During development, set `MAIL_MAILER=log` to write emails to `storage/logs/laravel.log` instead of sending them.

### 5. Start the Development Server

```bash
php artisan serve
```

The API will be available at `http://localhost:8000`.

## Manual Installation (Alternative)

If you prefer to run each step manually instead of using `daftara:install`:

```bash
# 1. Create .env file
cp .env.example .env

# 2. Generate application key
php artisan key:generate

# 3. Run migrations
php artisan migrate

# 4. Seed essential data
php artisan db:seed --class="App\Modules\Auth\Infrastructure\Seeders\RolesAndPermissionsSeeder"
php artisan db:seed --class="App\Modules\Notifications\Infrastructure\Seeders\NotificationChannelsSeeder"
php artisan db:seed --class="App\Modules\Auth\Infrastructure\Seeders\UsersSeeder"

# 5. (Optional) Seed sample data
php artisan db:seed --class="App\Modules\Warehouse\Infrastructure\Seeders\WarehousesSeeder"
php artisan db:seed --class="App\Modules\Warehouse\Infrastructure\Seeders\InventoryItemsSeeder"
php artisan db:seed --class="App\Modules\Warehouse\Infrastructure\Seeders\WarehouseInventoryItemsSeeder"
php artisan db:seed --class="App\Modules\Notifications\Infrastructure\Seeders\WarehouseNotificationSubscriptionsSeeder"

# 6. Clear caches
php artisan config:clear
php artisan cache:clear
php artisan route:clear
```

## Demo Users

After installation, these users are available:

| User | Email | Password | Role |
|------|-------|----------|------|
| Super Admin | superadmin@daftara.com | password | superadmin |
| Warehouse Manager | manager@daftara.com | password | manager |
| Staff Member | staff@daftara.com | password | staff |

## Verify Installation

### 1. Test Login

```bash
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -H "Accept: application/json" \
  -d '{"email": "superadmin@daftara.com", "password": "password"}'
```

Expected response:
```json
{
  "success": true,
  "data": {
    "token": "1|abc123...",
    "user": {
      "id": 1,
      "name": "Super Admin",
      "email": "superadmin@daftara.com"
    }
  }
}
```

### 2. Test Authenticated Endpoint

```bash
curl -X GET http://localhost:8000/api/v1/auth/me \
  -H "Authorization: Bearer <token-from-login>" \
  -H "Accept: application/json"
```

### 3. Run Tests

```bash
php artisan test
```

All tests should pass with SQLite in-memory database (no external DB needed for tests).

## API Documentation

API docs are auto-generated by Scramble (dedoc/scramble) and available at:

```
http://localhost:8000/docs/api
```

OpenAPI JSON spec: `http://localhost:8000/docs/api.json`

## Troubleshooting

### Database Connection Error
Make sure MySQL is running and the credentials in `.env` are correct. Create the database manually if needed:
```sql
CREATE DATABASE daftara CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### Permission Denied Errors
Ensure storage and cache directories are writable:
```bash
chmod -R 775 storage bootstrap/cache
```

### Scramble Docs Not Loading
Clear config cache and check for errors:
```bash
php artisan config:clear
php artisan route:clear
```
